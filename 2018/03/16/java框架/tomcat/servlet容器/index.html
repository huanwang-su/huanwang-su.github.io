<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="tomcat," />










<meta name="description" content="5 servlet容器容器有4种，都继承自org.apache.catalina.Container接口 5.1 Container以下结合容器接口代码，拆分了接口 4种容器：  Engine 表示整个Catalina servlet引擎 Host 表示包含一个或个Context的虚拟主机 Context 表示一个web应用，包含多个Wrapper Wrapper 表示一个独立的servlet">
<meta name="keywords" content="tomcat">
<meta property="og:type" content="article">
<meta property="og:title" content="tomcat servlet容器">
<meta property="og:url" content="http://hvan.wang/2018/03/16/java框架/tomcat/servlet容器/index.html">
<meta property="og:site_name" content="王焕の博客">
<meta property="og:description" content="5 servlet容器容器有4种，都继承自org.apache.catalina.Container接口 5.1 Container以下结合容器接口代码，拆分了接口 4种容器：  Engine 表示整个Catalina servlet引擎 Host 表示包含一个或个Context的虚拟主机 Context 表示一个web应用，包含多个Wrapper Wrapper 表示一个独立的servlet">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://img.blog.csdn.net/20150811090655055?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/0063bT3ggy1fl0m355fixj30uv0csq6g.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/0063bT3ggy1fl8px28fc1j307r06oglk.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/0063bT3ggy1fl8q0p9i8qj30d90olmyh.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/0063bT3ggy1fl8u0hslbcj30ij0gfwf3.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/0063bT3gly1fl0nnawc7vj30h303974a.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/0063bT3ggy1fl67jf3fhqj30m80enjso.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/0063bT3ggy1fl5agchpivj30jr0oumya.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/0063bT3ggy1fl0poim6h2j30dd0770su.jpg">
<meta property="og:image" content="http://img.blog.csdn.net/20150811090655055?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/0063bT3ggy1fl60btr6fxj30jh0l1aan.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/0063bT3ggy1fl60jixmr2j30kk0eoq3b.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/0063bT3ggy1fl65phrspxj30ks0dw3yx.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/0063bT3ggy1fl6731h9kcj30m906ft8s.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/0063bT3ggy1fl8igxjsxhj30fn0q5abb.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/0063bT3ggy1fl8om2diiwj30ib0fadgq.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/0063bT3ggy1fl8pkdoezjj30ed04h0sq.jpg">
<meta property="og:updated_time" content="2018-03-28T16:50:59.165Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="tomcat servlet容器">
<meta name="twitter:description" content="5 servlet容器容器有4种，都继承自org.apache.catalina.Container接口 5.1 Container以下结合容器接口代码，拆分了接口 4种容器：  Engine 表示整个Catalina servlet引擎 Host 表示包含一个或个Context的虚拟主机 Context 表示一个web应用，包含多个Wrapper Wrapper 表示一个独立的servlet">
<meta name="twitter:image" content="http://img.blog.csdn.net/20150811090655055?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://hvan.wang/2018/03/16/java框架/tomcat/servlet容器/"/>





  <title>tomcat servlet容器 | 王焕の博客</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?fda2ef7e04824cae7d02f2026268a57c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">王焕の博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://hvan.wang/2018/03/16/java框架/tomcat/servlet容器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王焕">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ww1.sinaimg.cn/large/0063bT3ggy1fpdlwgeh51j305t08q765.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王焕の博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">tomcat servlet容器</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-16T08:28:25+08:00">
                2018-03-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java框架/" itemprop="url" rel="index">
                    <span itemprop="name">java框架</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java框架/tomcat/" itemprop="url" rel="index">
                    <span itemprop="name">tomcat</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/16/java框架/tomcat/servlet容器/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count gitment-comments-count" data-xid="/2018/03/16/java框架/tomcat/servlet容器/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="http://img.blog.csdn.net/20150811090655055?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></p>
<h1 id="5-servlet容器"><a href="#5-servlet容器" class="headerlink" title="5 servlet容器"></a>5 servlet容器</h1><p>容器有4种，都继承自org.apache.catalina.Container接口</p>
<h2 id="5-1-Container"><a href="#5-1-Container" class="headerlink" title="5.1 Container"></a>5.1 Container</h2><p><strong><em>以下结合容器接口代码，拆分了接口</em></strong></p>
<p>4种容器：</p>
<ul>
<li>Engine 表示整个Catalina servlet引擎</li>
<li>Host 表示包含一个或个Context的虚拟主机</li>
<li>Context 表示一个web应用，包含多个Wrapper</li>
<li>Wrapper 表示一个独立的servlet</li>
</ul>
<p>这4种容器都有各自实现的类，分别是 StandardXXX，在org.apache.catalina.core内</p>
<p><img src="http://ww1.sinaimg.cn/large/0063bT3ggy1fl0m355fixj30uv0csq6g.jpg" alt=""></p>
<p>每一个上层容器都包含多个下层子容器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 父子容器关系，接口 */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addChild</span><span class="params">(Container child)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeChild</span><span class="params">(Container child)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Container <span class="title">findChild</span><span class="params">(String name)</span></span>;</span><br><span class="line"><span class="keyword">public</span> Container[] findChildren();</span><br><span class="line"><span class="function"><span class="keyword">public</span> Container <span class="title">getParent</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParent</span><span class="params">(Container container)</span></span>;</span><br></pre></td></tr></table></figure>
<p>容器可以包含一些组件，如载入器、记录器、管理器、域和Resource，暂且可以忽略</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Log <span class="title">getLogger</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRealm</span><span class="params">(Realm realm)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Realm <span class="title">getRealm</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> ClassLoader <span class="title">getParentClassLoader</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParentClassLoader</span><span class="params">(ClassLoader parent)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> AccessLog <span class="title">getAccessLog</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCluster</span><span class="params">(Cluster cluster)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Cluster <span class="title">getCluster</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>在部署应用时，可以通过配置server.xml来决定使用哪种容器。这是通过管道（pipeline）和阀值（valve）的实现。</p>
<h3 id="5-1-1-Lifecycle接口"><a href="#5-1-1-Lifecycle接口" class="headerlink" title="5.1.1 Lifecycle接口"></a>5.1.1 Lifecycle接口</h3><p>Container 继承自 Lifecycle，所以每一个<strong>Container都是一个组件，有组件的周期</strong> ，下面是Lifecycle的接口</p>
<blockquote>
<p>Lifecycle：Catalina components may implement this interface in order to provide a consistent mechanism to start and stop the component.  </p>
<p>代表了一个组件的周期</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&gt;             start()</span><br><span class="line">&gt;   -----------------------------</span><br><span class="line">&gt;   |                           |</span><br><span class="line">&gt;   | init()                    |</span><br><span class="line">&gt;  NEW -»-- INITIALIZING        |</span><br><span class="line">&gt;  | |           |              |     ------------------«-----------------------</span><br><span class="line">&gt;  | |           |auto          |     |                                        |</span><br><span class="line">&gt;  | |          \|/    start() \|/   \|/     auto          auto         stop() |</span><br><span class="line">&gt;  | |      INITIALIZED --»-- STARTING_PREP --»- STARTING --»- STARTED --»---  |</span><br><span class="line">&gt;  | |         |                                                            |  |</span><br><span class="line">&gt;  | |destroy()|                                                            |  |</span><br><span class="line">&gt;  | --»-----«--    ------------------------«--------------------------------  ^</span><br><span class="line">&gt;  |     |          |                                                          |</span><br><span class="line">&gt;  |     |         \|/          auto                 auto              start() |</span><br><span class="line">&gt;  |     |     STOPPING_PREP ----»---- STOPPING ------»----- STOPPED -----»-----</span><br><span class="line">&gt;  |    \|/                               ^                     |  ^</span><br><span class="line">&gt;  |     |               stop()           |                     |  |</span><br><span class="line">&gt;  |     |       --------------------------                     |  |</span><br><span class="line">&gt;  |     |       |                                              |  |</span><br><span class="line">&gt;  |     |       |    destroy()                       destroy() |  |</span><br><span class="line">&gt;  |     |    FAILED ----»------ DESTROYING ---«-----------------  |</span><br><span class="line">&gt;  |     |                        ^     |                          |</span><br><span class="line">&gt;  |     |     destroy()          |     |auto                      |</span><br><span class="line">&gt;  |     --------»-----------------    \|/                         |</span><br><span class="line">&gt;  |                                 DESTROYED                     |</span><br><span class="line">&gt;  |                                                               |</span><br><span class="line">&gt;  |                            stop()                             |</span><br><span class="line">&gt;  ----»-----------------------------»------------------------------</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="5-1-2-ContainerBase"><a href="#5-1-2-ContainerBase" class="headerlink" title="5.1.2 ContainerBase"></a>5.1.2 ContainerBase</h3><p><img src="http://ww1.sinaimg.cn/large/0063bT3ggy1fl8px28fc1j307r06oglk.jpg" alt=""></p>
<p>LifecycleBase和其接口在第六章描述</p>
<p>LifecycleMBeanBase实现了JmxEnable和Container接口</p>
<h4 id="5-1-2-1-Container接口"><a href="#5-1-2-1-Container接口" class="headerlink" title="5.1.2.1 Container接口"></a>5.1.2.1 Container接口</h4><p>主要对父子容器的操作，监听，以及管道，阀等组件</p>
<p><img src="http://ww1.sinaimg.cn/large/0063bT3ggy1fl8q0p9i8qj30d90olmyh.jpg" alt=""></p>
<h4 id="5-1-2-2-JmxEnable接口"><a href="#5-1-2-2-JmxEnable接口" class="headerlink" title="5.1.2.2 JmxEnable接口"></a>5.1.2.2 JmxEnable接口</h4><p>用于JMX的管理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JmxEnabled</span> <span class="keyword">extends</span> <span class="title">MBeanRegistration</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">getDomain</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDomain</span><span class="params">(String domain)</span></span>;</span><br><span class="line">    <span class="function">ObjectName <span class="title">getObjectName</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-1-2-3-ContainerBase-实现"><a href="#5-1-2-3-ContainerBase-实现" class="headerlink" title="5.1.2.3 ContainerBase 实现"></a>5.1.2.3 ContainerBase 实现</h4><p>ContainerBase 主要处理4个公共组件，cluster，childContainer，pipeLine和Realm，对于childContainer使用线程池操作，线程池在init时创建，意味着每个容器都有个线程池</p>
<p><img src="http://ww1.sinaimg.cn/large/0063bT3ggy1fl8u0hslbcj30ij0gfwf3.jpg" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">       BlockingQueue&lt;Runnable&gt; startStopQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</span><br><span class="line">       startStopExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">               getStartStopThreadsInternal(),</span><br><span class="line">               getStartStopThreadsInternal(), <span class="number">10</span>, TimeUnit.SECONDS,</span><br><span class="line">               startStopQueue,</span><br><span class="line">               <span class="keyword">new</span> StartStopThreadFactory(getName() + <span class="string">"-startStop-"</span>));</span><br><span class="line">       startStopExecutor.allowCoreThreadTimeOut(<span class="keyword">true</span>);</span><br><span class="line">       <span class="keyword">super</span>.initInternal();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">       logger = <span class="keyword">null</span>;</span><br><span class="line">       getLogger();</span><br><span class="line">       Cluster cluster = getClusterInternal();</span><br><span class="line">       <span class="keyword">if</span> (cluster <span class="keyword">instanceof</span> Lifecycle) &#123;</span><br><span class="line">           ((Lifecycle) cluster).start();</span><br><span class="line">       &#125;</span><br><span class="line">       Realm realm = getRealmInternal();</span><br><span class="line">       <span class="keyword">if</span> (realm <span class="keyword">instanceof</span> Lifecycle) &#123;</span><br><span class="line">           ((Lifecycle) realm).start();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// Start our child containers, if any</span></span><br><span class="line">       Container children[] = findChildren();</span><br><span class="line">       List&lt;Future&lt;Void&gt;&gt; results = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">           results.add(startStopExecutor.submit(<span class="keyword">new</span> StartChild(children[i])));</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">boolean</span> fail = <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">for</span> (Future&lt;Void&gt; result : results) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               result.get();</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               log.error(sm.getString(<span class="string">"containerBase.threadedStartFailed"</span>), e);</span><br><span class="line">               fail = <span class="keyword">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (fail) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(</span><br><span class="line">                   sm.getString(<span class="string">"containerBase.threadedStartFailed"</span>));</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Start the Valves in our pipeline (including the basic), if any</span></span><br><span class="line">       <span class="keyword">if</span> (pipeline <span class="keyword">instanceof</span> Lifecycle)</span><br><span class="line">           ((Lifecycle) pipeline).start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       setState(LifecycleState.STARTING);</span><br><span class="line">       threadStart();<span class="comment">// 用thread启动处理backgroundProcessor()方法</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">stopInternal类似startInternal</span><br></pre></td></tr></table></figure>
<h2 id="5-2-管道任务"><a href="#5-2-管道任务" class="headerlink" title="5.2 管道任务"></a>5.2 管道任务</h2><p>联想tomcat的过滤器，一次调用是经过了多个过滤器的，过滤器类似valve，pipeline是装载valve的容器，通常是链表。</p>
<ul>
<li>pipeline：管道包含该servlet容器将要调用的任务。</li>
</ul>
<ul>
<li>valve：一个阀表示一个具体的任务。</li>
</ul>
<p><img src="http://ww1.sinaimg.cn/large/0063bT3gly1fl0nnawc7vj30h303974a.jpg" alt=""></p>
<p>在ContainerBase（四大组件的基类）中包含有一个pipeline和HashMap&lt;String, Container&gt; children 的子容器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Pipeline</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Valve <span class="title">getBasic</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBasic</span><span class="params">(Valve valve)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addValve</span><span class="params">(Valve valve)</span></span>;</span><br><span class="line">    <span class="keyword">public</span> Valve[] getValves();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeValve</span><span class="params">(Valve valve)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Valve <span class="title">getFirst</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAsyncSupported</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Container <span class="title">getContainer</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContainer</span><span class="params">(Container container)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findNonAsyncValves</span><span class="params">(Set&lt;String&gt; result)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.catalina;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Valve</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Valve <span class="title">getNext</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNext</span><span class="params">(Valve valve)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">backgroundProcess</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span> <span class="keyword">throws</span> IOException, ServletException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAsyncSupported</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在调用了servlet的执行方法时，实际上是执行了pipeline中的valve。注意pipeline中包含一个baseValve，不同于valve[]。</p>
<blockquote>
<h3 id="5-2-1-ValveContext-实现阀的遍历"><a href="#5-2-1-ValveContext-实现阀的遍历" class="headerlink" title="5.2.1 ValveContext 实现阀的遍历"></a>5.2.1 ValveContext 实现阀的遍历</h3><p>在tomcat8.5中被淘汰。。。。。。</p>
<p>参考深入剖析Tomcat一书，在低版本中，通过ValveContext实现遍历，ContainerBase和pipeline都有public void invoke(Request request, Response response)的方法签名，ValveContext是Pipeline的内部类，也有该签名，通过层层调用，最后由ValveContext遍历。同时会发现ContainerBase和pipeline也删除了该签名方法</p>
<p><strong>淘汰原因</strong>：只想让Container和Pipeline只做容器，而不处理，将处理抽象出来</p>
</blockquote>
<h3 id="5-2-2-Contained接口"><a href="#5-2-2-Contained接口" class="headerlink" title="5.2.2 Contained接口"></a>5.2.2 Contained接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Contained</span> </span>&#123;</span><br><span class="line">    <span class="function">Container <span class="title">getContainer</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setContainer</span><span class="params">(Container container)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ValveBase和PipelineBase均实现该接口</p>
<h2 id="5-3-Wrapper容器"><a href="#5-3-Wrapper容器" class="headerlink" title="5.3 Wrapper容器"></a>5.3 Wrapper容器</h2><p>Wrapper内部处理流程</p>
<p><img src="http://ww1.sinaimg.cn/large/0063bT3ggy1fl67jf3fhqj30m80enjso.jpg" alt=""></p>
<h3 id="5-3-1-Wrapper接口"><a href="#5-3-1-Wrapper接口" class="headerlink" title="5.3.1 Wrapper接口"></a>5.3.1 Wrapper接口</h3><p>Wrapper实现类主要负责管理基础Servlet类的servlet的生命周期，是最低级的容器。</p>
<p>Wrapper的父容器只能是Context，对子容器操作是会抛异常</p>
<p><img src="http://ww1.sinaimg.cn/large/0063bT3ggy1fl5agchpivj30jr0oumya.jpg" alt=""></p>
<blockquote>
<p>为啥是最低的，参看 StandardXXX.java</p>
<p><img src="http://ww1.sinaimg.cn/large/0063bT3ggy1fl0poim6h2j30dd0770su.jpg" alt=""></p>
</blockquote>
<h4 id="5-3-1-1-获取servlet："><a href="#5-3-1-1-获取servlet：" class="headerlink" title="5.3.1.1 获取servlet："></a>5.3.1.1 获取servlet：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> <span class="keyword">throws</span> ServletException</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Servlet <span class="title">allocate</span><span class="params">()</span> <span class="keyword">throws</span> ServletException</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>allocate()：分配一个已准备好调用其service()方法的Servlet的初始化实例。 </li>
<li>load()：如果尚未有一个已初始化的实例，则加载并初始化此Servlet（一对一）的实例。可以在服务器启动时预加载部署描述符中标记的Servlet。</li>
</ul>
<h3 id="5-3-2-StandardWrapper"><a href="#5-3-2-StandardWrapper" class="headerlink" title="5.3.2 StandardWrapper"></a>5.3.2 StandardWrapper</h3><p>StandardWrapper主要负责载入它所代表的servlet类，并进行实例化，但是它并不调用servlet的service方法，该方法由StandardWrapperValve对象完成（作为基础阀）</p>
<p>当第一次请求某个servlet时，StandardWrapper载入servlet类，由于会动态载入，因此必须知道完全限定名，可以调用setServletClass设置。</p>
<h4 id="5-3-2-1-方法调用序列"><a href="#5-3-2-1-方法调用序列" class="headerlink" title="5.3.2.1 方法调用序列"></a>5.3.2.1 方法调用序列</h4><p>方法的调用是通过管道调用的，基础阀最后调用，基础阀会调用子容器的管道</p>
<p><img src="http://img.blog.csdn.net/20150811090655055?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></p>
<h4 id="5-3-2-2-load"><a href="#5-3-2-2-load" class="headerlink" title="5.3.2.2 load"></a>5.3.2.2 load</h4><p>如果还没有至少一个初始化实例，则加载并初始化此servlet的一个实例。 </p>
<p>load调用了loadServlet()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Servlet <span class="title">loadServlet</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Nothing to do if we already have an instance or an instance pool</span></span><br><span class="line">	<span class="keyword">if</span> (!singleThreadModel &amp;&amp; (instance != <span class="keyword">null</span>))</span><br><span class="line">		<span class="keyword">return</span> instance;</span><br><span class="line"></span><br><span class="line">	PrintStream out = System.out;</span><br><span class="line">	<span class="keyword">if</span> (swallowOutput) &#123;</span><br><span class="line">		SystemLogHandler.startCapture();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Servlet servlet;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">long</span> t1=System.currentTimeMillis();</span><br><span class="line">		<span class="comment">// Complain if no servlet class has been specified</span></span><br><span class="line">		<span class="keyword">if</span> (servletClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">			unavailable(<span class="keyword">null</span>);</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ServletException</span><br><span class="line">				(sm.getString(<span class="string">"standardWrapper.notClass"</span>, getName()));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		InstanceManager instanceManager = ((StandardContext)getParent()).getInstanceManager();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			servlet = (Servlet) instanceManager.newInstance(servletClass);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</span><br><span class="line">			unavailable(<span class="keyword">null</span>);</span><br><span class="line">			<span class="comment">//...</span></span><br><span class="line">		&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">			unavailable(<span class="keyword">null</span>);</span><br><span class="line">			<span class="comment">//...	</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (multipartConfigElement == <span class="keyword">null</span>) &#123;</span><br><span class="line">			MultipartConfig annotation =</span><br><span class="line">					servlet.getClass().getAnnotation(MultipartConfig.class);</span><br><span class="line">			<span class="keyword">if</span> (annotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">				multipartConfigElement =</span><br><span class="line">						<span class="keyword">new</span> MultipartConfigElement(annotation);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		processServletSecurityAnnotation(servlet.getClass());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (servlet <span class="keyword">instanceof</span> ContainerServlet) &#123;</span><br><span class="line">			((ContainerServlet) servlet).setWrapper(<span class="keyword">this</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		classLoadTime=(<span class="keyword">int</span>) (System.currentTimeMillis() -t1);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (servlet <span class="keyword">instanceof</span> SingleThreadModel) &#123;</span><br><span class="line">			<span class="keyword">if</span> (instancePool == <span class="keyword">null</span>) &#123;</span><br><span class="line">				instancePool = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line">			&#125;</span><br><span class="line">			singleThreadModel = <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		initServlet(servlet);</span><br><span class="line"></span><br><span class="line">		fireContainerEvent(<span class="string">"load"</span>, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">		loadTime=System.currentTimeMillis() -t1;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (swallowOutput) &#123;</span><br><span class="line">			<span class="comment">//log</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> servlet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-3-2-2-allocate"><a href="#5-3-2-2-allocate" class="headerlink" title="5.3.2.2 allocate"></a>5.3.2.2 allocate</h4><p>分配一个已经准备好调用service（）方法的Servlet的初始化实例。 如果servlet类没有实现SingleThreadModel，则（仅）已初始化的实例可能会立即返回。 如果servlet类实现了SingleThreadModel，那么Wrapper实现必须确保这个实例在被deallocate（）调用解除分配之前不会被再次分配。</p>
<p>SingleThreadModel防止一个servlet的service同时被多个线程调用，通过synchronized和池化处理。请注意，SingleThreadModel不能解决所有线程安全问题。 例如，即使在使用SingleThreadModel servlet的时候，会话属性和静态变量仍然可以同时被多个线程上的多个请求访问。该接口已被淘汰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Servlet <span class="title">allocate</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If we are currently unloading this servlet, throw an exception</span></span><br><span class="line">	<span class="keyword">if</span> (unloading) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> ServletException(sm.getString(<span class="string">"standardWrapper.unloading"</span>, getName()));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">boolean</span> newInstance = <span class="keyword">false</span>;</span><br><span class="line">	<span class="comment">// If not SingleThreadedModel, return the same instance every time</span></span><br><span class="line">	<span class="keyword">if</span> (!singleThreadModel) &#123;</span><br><span class="line">		<span class="comment">// Load and initialize our instance if necessary</span></span><br><span class="line">		<span class="keyword">if</span> (instance == <span class="keyword">null</span> || !instanceInitialized) &#123;</span><br><span class="line">			<span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						<span class="comment">// Note: We don't know if the Servlet implements</span></span><br><span class="line">						<span class="comment">// SingleThreadModel until we have loaded it.</span></span><br><span class="line">						instance = loadServlet();</span><br><span class="line">						newInstance = <span class="keyword">true</span>;</span><br><span class="line">						<span class="keyword">if</span> (!singleThreadModel) &#123;</span><br><span class="line">							countAllocated.incrementAndGet();</span><br><span class="line">						&#125;</span><br><span class="line">					&#125; <span class="keyword">catch</span> (ServletException e) &#123;</span><br><span class="line">						<span class="comment">//...</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (!instanceInitialized) &#123;</span><br><span class="line">					initServlet(instance);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (singleThreadModel) &#123;</span><br><span class="line">			<span class="keyword">if</span> (newInstance) &#123;</span><br><span class="line">				<span class="comment">// Have to do this outside of the sync above to prevent a</span></span><br><span class="line">				<span class="comment">// possible deadlock</span></span><br><span class="line">				<span class="keyword">synchronized</span> (instancePool) &#123;</span><br><span class="line">					instancePool.push(instance);</span><br><span class="line">					nInstances++;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// For new instances, count will have been incremented at the</span></span><br><span class="line">			<span class="comment">// time of creation</span></span><br><span class="line">			<span class="keyword">if</span> (!newInstance) &#123;</span><br><span class="line">				countAllocated.incrementAndGet();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> instance;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">synchronized</span> (instancePool) &#123;</span><br><span class="line">		<span class="keyword">while</span> (countAllocated.get() &gt;= nInstances) &#123;</span><br><span class="line">			<span class="comment">// Allocate a new instance if possible, or else wait</span></span><br><span class="line">			<span class="keyword">if</span> (nInstances &lt; maxInstances) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					instancePool.push(loadServlet());</span><br><span class="line">					nInstances++;</span><br><span class="line">				&#125; <span class="keyword">catch</span> (ServletException e) &#123;</span><br><span class="line">					<span class="comment">//...</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					instancePool.wait();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					<span class="comment">// Ignore</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		countAllocated.incrementAndGet();</span><br><span class="line">		<span class="keyword">return</span> instancePool.pop();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>countAllocated.incrementAndGet() 用来计算分配次数</p>
</li>
<li><p>对于非singleThreadModel采用单例模式，但由于第一次加载不知道singleThreadModel，要特殊处理</p>
</li>
<li><p>对于singleThreadModel采用对象池，利用了wait，signal</p>
</li>
<li><p>对于singleThreadModel的回收</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deallocate</span><span class="params">(Servlet servlet)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">	<span class="comment">// If not SingleThreadModel, no action is required</span></span><br><span class="line">	<span class="keyword">if</span> (!singleThreadModel) &#123;</span><br><span class="line">		countAllocated.decrementAndGet();</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Unlock and free this instance</span></span><br><span class="line">	<span class="keyword">synchronized</span> (instancePool) &#123;</span><br><span class="line">		countAllocated.decrementAndGet();</span><br><span class="line">		instancePool.push(servlet);</span><br><span class="line">		instancePool.notify();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-3-2-2-ServletConfig与初始化"><a href="#5-3-2-2-ServletConfig与初始化" class="headerlink" title="5.3.2.2 ServletConfig与初始化"></a>5.3.2.2 ServletConfig与初始化</h4><p>一个servlet配置对象，由servlet容器在初始化期间将信息传递给servlet。servlet初始化需要一个ServletConfig</p>
<p>servlet.init(facade);为了安全传入个外观类，</p>
<blockquote>
<p>初始化时示例：init() in GenericServlet</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">if</span> (getServletConfig().getInitParameter(<span class="string">"input"</span>) != <span class="keyword">null</span>)</span><br><span class="line">&gt;    input = Integer.parseInt(getServletConfig().getInitParameter(<span class="string">"input"</span>));</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>​</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServletConfig</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getServletName</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletContext <span class="title">getServletContext</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getInitParameter</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Enumeration&lt;String&gt; <span class="title">getInitParameterNames</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在StandardWrapper中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// wrapper name同servletName</span><br><span class="line">public String getServletName() &#123;</span><br><span class="line">	return (getName());</span><br><span class="line">&#125;</span><br><span class="line">@Override</span><br><span class="line">public ServletContext getServletContext() &#123;</span><br><span class="line"></span><br><span class="line">	if (parent == null)</span><br><span class="line">		return (null);</span><br><span class="line">	else if (!(parent instanceof Context))</span><br><span class="line">		return (null);</span><br><span class="line">	else</span><br><span class="line">		return (((Context) parent).getServletContext());</span><br><span class="line">&#125;</span><br><span class="line">@Override</span><br><span class="line">public String getInitParameter(String name) &#123;</span><br><span class="line"></span><br><span class="line">	return (findInitParameter(name));</span><br><span class="line"></span><br><span class="line">&#125;    </span><br><span class="line">@Override</span><br><span class="line">public Enumeration&lt;String&gt; getInitParameterNames() &#123;</span><br><span class="line"></span><br><span class="line">	parametersLock.readLock().lock();</span><br><span class="line">	try &#123;</span><br><span class="line">		return Collections.enumeration(parameters.keySet());</span><br><span class="line">	&#125; finally &#123;</span><br><span class="line">		parametersLock.readLock().unlock();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​</p>
</li>
</ul>
<h3 id="5-4-3-StandardWrapperFacade"><a href="#5-4-3-StandardWrapperFacade" class="headerlink" title="5.4.3 StandardWrapperFacade"></a>5.4.3 StandardWrapperFacade</h3><p>只是用来构建Servlet的，简化版StandardWrapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">StandardWrapperFacade</span> <span class="keyword">implements</span> <span class="title">ServletConfig</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StandardWrapperFacade</span><span class="params">(StandardWrapper config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.config = config;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServletConfig config;</span><br><span class="line">    <span class="keyword">private</span> ServletContext context = <span class="keyword">null</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getServletName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> config.getServletName();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletContext <span class="title">getServletContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line">            context = config.getServletContext();</span><br><span class="line">            <span class="keyword">if</span> (context <span class="keyword">instanceof</span> ApplicationContext) &#123;</span><br><span class="line">                context = ((ApplicationContext) context).getFacade();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (context);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getInitParameter</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> config.getInitParameter(name);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Enumeration&lt;String&gt; <span class="title">getInitParameterNames</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> config.getInitParameterNames();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-4-4-StandardWrapperValve"><a href="#5-4-4-StandardWrapperValve" class="headerlink" title="5.4.4 StandardWrapperValve"></a>5.4.4 StandardWrapperValve</h3><p>StandardWrapperValve是StandardWrapper的基础阀，wrapper的最后一个valve，要完成两个操作：</p>
<ul>
<li>执行与该servlet关联的全部过滤器</li>
<li>调用servlet的service方法</li>
</ul>
<p>StandardWrapperValve的实现主要是invoke方法</p>
<ol>
<li>调用StandardWrapper的allocate获取servlet</li>
<li>调用ApplicationFilterFactory.createFilterChain创建过滤器链</li>
<li>调用过滤器链的doFilter，其中包括servlet的service方法</li>
<li>释放filterChain</li>
<li>调用Wrapper的deallocate</li>
<li>若servlet不会再用，调用Wrapper的unload()</li>
</ol>
<p><strong>源码分部解析</strong></p>
<ol>
<li><p>校验父容器的有效性，以及Wrapper分配servlet，处理该过程的异常，异常会response.sendError，发送错误相应给客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span></span><br><span class="line"><span class="function">	<span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">	<span class="comment">// Initialize local variables we may need</span></span><br><span class="line">	<span class="keyword">boolean</span> unavailable = <span class="keyword">false</span>;</span><br><span class="line">	Throwable throwable = <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">// This should be a Request attribute...</span></span><br><span class="line">	<span class="keyword">long</span> t1=System.currentTimeMillis();</span><br><span class="line">	requestCount.incrementAndGet();</span><br><span class="line">	StandardWrapper wrapper = (StandardWrapper) getContainer();</span><br><span class="line">	Servlet servlet = <span class="keyword">null</span>;</span><br><span class="line">	Context context = (Context) wrapper.getParent();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Check for the application being marked unavailable</span></span><br><span class="line">	<span class="keyword">if</span> (!context.getState().isAvailable()) &#123;</span><br><span class="line">		response.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE,</span><br><span class="line">					   sm.getString(<span class="string">"standardContext.isUnavailable"</span>));</span><br><span class="line">		unavailable = <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Check for the servlet being marked unavailable</span></span><br><span class="line">	<span class="keyword">if</span> (!unavailable &amp;&amp; wrapper.isUnavailable()) &#123;</span><br><span class="line">		container.getLogger().info(sm.getString(<span class="string">"standardWrapper.isUnavailable"</span>,</span><br><span class="line">				wrapper.getName()));</span><br><span class="line">		<span class="keyword">long</span> available = wrapper.getAvailable();</span><br><span class="line">		<span class="keyword">if</span> ((available &gt; <span class="number">0L</span>) &amp;&amp; (available &lt; Long.MAX_VALUE)) &#123;</span><br><span class="line">			response.setDateHeader(<span class="string">"Retry-After"</span>, available);</span><br><span class="line">			response.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE,</span><br><span class="line">					sm.getString(<span class="string">"standardWrapper.isUnavailable"</span>,</span><br><span class="line">							wrapper.getName()));</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (available == Long.MAX_VALUE) &#123;</span><br><span class="line">			response.sendError(HttpServletResponse.SC_NOT_FOUND,</span><br><span class="line">					sm.getString(<span class="string">"standardWrapper.notFound"</span>,</span><br><span class="line">							wrapper.getName()));</span><br><span class="line">		&#125;</span><br><span class="line">		unavailable = <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Allocate a servlet instance to process this request</span></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (!unavailable) &#123;</span><br><span class="line">			servlet = wrapper.allocate();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (UnavailableException e) &#123;</span><br><span class="line">		container.getLogger().error(</span><br><span class="line">				sm.getString(<span class="string">"standardWrapper.allocateException"</span>,</span><br><span class="line">						wrapper.getName()), e);</span><br><span class="line">		<span class="keyword">long</span> available = wrapper.getAvailable();</span><br><span class="line">		<span class="keyword">if</span> ((available &gt; <span class="number">0L</span>) &amp;&amp; (available &lt; Long.MAX_VALUE)) &#123;</span><br><span class="line">			response.setDateHeader(<span class="string">"Retry-After"</span>, available);</span><br><span class="line">			response.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE,</span><br><span class="line">					   sm.getString(<span class="string">"standardWrapper.isUnavailable"</span>,</span><br><span class="line">									wrapper.getName()));</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (available == Long.MAX_VALUE) &#123;</span><br><span class="line">			response.sendError(HttpServletResponse.SC_NOT_FOUND,</span><br><span class="line">					   sm.getString(<span class="string">"standardWrapper.notFound"</span>,</span><br><span class="line">									wrapper.getName()));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (ServletException e) &#123;</span><br><span class="line">		container.getLogger().error(sm.getString(<span class="string">"standardWrapper.allocateException"</span>,</span><br><span class="line">						 wrapper.getName()), StandardWrapper.getRootCause(e));</span><br><span class="line">		throwable = e;</span><br><span class="line">		exception(request, response, e);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">		ExceptionUtils.handleThrowable(e);</span><br><span class="line">		container.getLogger().error(sm.getString(<span class="string">"standardWrapper.allocateException"</span>,</span><br><span class="line">						 wrapper.getName()), e);</span><br><span class="line">		throwable = e;</span><br><span class="line">		exception(request, response, e);</span><br><span class="line">		servlet = <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​</p>
</li>
<li><p>创建过滤器链</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MessageBytes requestPathMB = request.getRequestPathMB();</span><br><span class="line">DispatcherType dispatcherType = DispatcherType.REQUEST;</span><br><span class="line"><span class="keyword">if</span> (request.getDispatcherType()==DispatcherType.ASYNC) dispatcherType = DispatcherType.ASYNC;</span><br><span class="line">request.setAttribute(Globals.DISPATCHER_TYPE_ATTR,dispatcherType);</span><br><span class="line">request.setAttribute(Globals.DISPATCHER_REQUEST_PATH_ATTR,</span><br><span class="line">                     requestPathMB);</span><br><span class="line"><span class="comment">// Create the filter chain for this request</span></span><br><span class="line">ApplicationFilterChain filterChain =</span><br><span class="line">  ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</span><br></pre></td></tr></table></figure>
</li>
<li><p>dofilter</p>
<p>在filterChain.doFilter时有很多异常，还分为异步同步处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> ((servlet != <span class="keyword">null</span>) &amp;&amp; (filterChain != <span class="keyword">null</span>)) &#123;</span><br><span class="line">		<span class="comment">// Swallow output if needed</span></span><br><span class="line">		<span class="keyword">if</span> (context.getSwallowOutput()) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				SystemLogHandler.startCapture();</span><br><span class="line">				<span class="keyword">if</span> (request.isAsyncDispatching()) &#123;</span><br><span class="line">					request.getAsyncContextInternal().doInternalDispatch();</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					filterChain.doFilter(request.getRequest(),</span><br><span class="line">							response.getResponse());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">				String log = SystemLogHandler.stopCapture();</span><br><span class="line">				<span class="keyword">if</span> (log != <span class="keyword">null</span> &amp;&amp; log.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">					context.getLogger().info(log);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (request.isAsyncDispatching()) &#123;</span><br><span class="line">				request.getAsyncContextInternal().doInternalDispatch();</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				filterChain.doFilter</span><br><span class="line">					(request.getRequest(), response.getResponse());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (ClientAbortException e) &#123;</span><br><span class="line">	throwable = e;</span><br><span class="line">	exception(request, response, e);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">	container.getLogger().error(sm.getString(</span><br><span class="line">			<span class="string">"standardWrapper.serviceException"</span>, wrapper.getName(),</span><br><span class="line">			context.getName()), e);</span><br><span class="line">	throwable = e;</span><br><span class="line">	exception(request, response, e);</span><br><span class="line">&#125; <span class="keyword">catch</span> (UnavailableException e) &#123;</span><br><span class="line">	container.getLogger().error(sm.getString(</span><br><span class="line">			<span class="string">"standardWrapper.serviceException"</span>, wrapper.getName(),</span><br><span class="line">			context.getName()), e);</span><br><span class="line">	<span class="comment">//            throwable = e;</span></span><br><span class="line">	<span class="comment">//            exception(request, response, e);</span></span><br><span class="line">	wrapper.unavailable(e);</span><br><span class="line">	<span class="keyword">long</span> available = wrapper.getAvailable();</span><br><span class="line">	<span class="keyword">if</span> ((available &gt; <span class="number">0L</span>) &amp;&amp; (available &lt; Long.MAX_VALUE)) &#123;</span><br><span class="line">		response.setDateHeader(<span class="string">"Retry-After"</span>, available);</span><br><span class="line">		response.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE,</span><br><span class="line">				   sm.getString(<span class="string">"standardWrapper.isUnavailable"</span>,</span><br><span class="line">								wrapper.getName()));</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (available == Long.MAX_VALUE) &#123;</span><br><span class="line">		response.sendError(HttpServletResponse.SC_NOT_FOUND,</span><br><span class="line">					sm.getString(<span class="string">"standardWrapper.notFound"</span>,</span><br><span class="line">								wrapper.getName()));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Do not save exception in 'throwable', because we</span></span><br><span class="line">	<span class="comment">// do not want to do exception(request, response, e) processing</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (ServletException e) &#123;</span><br><span class="line">	Throwable rootCause = StandardWrapper.getRootCause(e);</span><br><span class="line">	<span class="keyword">if</span> (!(rootCause <span class="keyword">instanceof</span> ClientAbortException)) &#123;</span><br><span class="line">		container.getLogger().error(sm.getString(</span><br><span class="line">				<span class="string">"standardWrapper.serviceExceptionRoot"</span>,</span><br><span class="line">				wrapper.getName(), context.getName(), e.getMessage()),</span><br><span class="line">				rootCause);</span><br><span class="line">	&#125;</span><br><span class="line">	throwable = e;</span><br><span class="line">	exception(request, response, e);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">	ExceptionUtils.handleThrowable(e);</span><br><span class="line">	container.getLogger().error(sm.getString(</span><br><span class="line">			<span class="string">"standardWrapper.serviceException"</span>, wrapper.getName(),</span><br><span class="line">			context.getName()), e);</span><br><span class="line">	throwable = e;</span><br><span class="line">	exception(request, response, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>释放过滤器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Release the filter chain (if any) for this request</span></span><br><span class="line"><span class="keyword">if</span> (filterChain != <span class="keyword">null</span>) &#123;</span><br><span class="line">	filterChain.release();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>回收servlet</p>
<p>参考Wrapper中的实现，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Deallocate the allocated servlet instance</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (servlet != <span class="keyword">null</span>) &#123;</span><br><span class="line">		wrapper.deallocate(servlet);</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">	ExceptionUtils.handleThrowable(e);</span><br><span class="line">	container.getLogger().error(sm.getString(<span class="string">"standardWrapper.deallocateException"</span>,</span><br><span class="line">					 wrapper.getName()), e);</span><br><span class="line">	<span class="keyword">if</span> (throwable == <span class="keyword">null</span>) &#123;</span><br><span class="line">		throwable = e;</span><br><span class="line">		exception(request, response, e);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>若servlet不会再用，调用Wrapper的unload()，getAvailable代表下次可用时间，后面的time提供统计信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If this servlet has been marked permanently unavailable,</span></span><br><span class="line"><span class="comment">// unload it and release this instance</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> ((servlet != <span class="keyword">null</span>) &amp;&amp;</span><br><span class="line">		(wrapper.getAvailable() == Long.MAX_VALUE)) &#123;</span><br><span class="line">		wrapper.unload();</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">	ExceptionUtils.handleThrowable(e);</span><br><span class="line">	container.getLogger().error(sm.getString(<span class="string">"standardWrapper.unloadException"</span>,</span><br><span class="line">					 wrapper.getName()), e);</span><br><span class="line">	<span class="keyword">if</span> (throwable == <span class="keyword">null</span>) &#123;</span><br><span class="line">		throwable = e;</span><br><span class="line">		exception(request, response, e);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">long</span> t2=System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> time=t2-t1;</span><br><span class="line">processingTime += time;</span><br><span class="line"><span class="keyword">if</span>( time &gt; maxTime) maxTime=time;</span><br><span class="line"><span class="keyword">if</span>( time &lt; minTime) minTime=time;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="5-4-4-过滤器"><a href="#5-4-4-过滤器" class="headerlink" title="5.4.4 过滤器"></a>5.4.4 过滤器</h3><h4 id="5-4-4-1-FilterDef"><a href="#5-4-4-1-FilterDef" class="headerlink" title="5.4.4.1 FilterDef"></a>5.4.4.1 FilterDef</h4><p>org.apache.tomcat.util.descriptor.web.FilterDef表示一个Filter的定义，as represented in a <code>&lt;filter&gt;</code> element in the deployment descriptor</p>
<p>parameters表示该过滤器的初始化参数</p>
<p><img src="http://ww1.sinaimg.cn/large/0063bT3ggy1fl60btr6fxj30jh0l1aan.jpg" alt=""></p>
<h4 id="5-4-4-2-FilterConfig"><a href="#5-4-4-2-FilterConfig" class="headerlink" title="5.4.4.2 FilterConfig"></a>5.4.4.2 FilterConfig</h4><p>过滤器配置对象，由servlet容器在初始化期间将信息传递给过滤器。实现了Def和Context的关联</p>
<p>ApplicationFilterConfig是其直接实现类</p>
<p><img src="http://ww1.sinaimg.cn/large/0063bT3ggy1fl60jixmr2j30kk0eoq3b.jpg" alt=""></p>
<ul>
<li>构造函数由Context和FilterDef组成</li>
<li>instanceManager管理器，创建和销毁Filter实例</li>
<li>getFilter用instanceManager创建，再初始化</li>
<li>初始化用filter.init(this);</li>
</ul>
<h4 id="5-4-4-3-Filter"><a href="#5-4-4-3-Filter" class="headerlink" title="5.4.4.3 Filter"></a>5.4.4.3 Filter</h4><p>过滤器是一个对资源请求（servlet或静态内容）或资源响应执行过滤任务的对象。过滤器在doFilter方法中执行过滤。 每个过滤器都可以通过一个FilterConfig对象获取其初始化参数，例如，可以使用对ServletContext的引用来加载过滤任务所需的资源。</p>
<p>过滤器是在Web应用程序的部署描述符中配置的</p>
<p>举例：</p>
<ul>
<li>Authentication Filters </li>
<li>Logging and Auditing Filters </li>
<li>Image conversion Filters </li>
<li>Data compression Filters </li>
<li>Encryption Filters </li>
<li>Tokenizing Filters </li>
<li>Filters that trigger resource access events </li>
<li>XSL/T filters </li>
<li>Mime-type chain Filter </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">            FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>doFilter方法的典型实现将遵循以下模式：</p>
<ol>
<li>检查请求</li>
<li><p>包装请求对象,筛选内容或标题</p>
<ol>
<li><p>自定义包装响应对象</p>
</li>
<li><p>a）使用FilterChain对象chain.doFilter调用链中的下一个实体，</p>
<p>b）或者不将请求/响应对传递给过滤器链中的下一个实体以阻止请求处理</p>
</li>
<li><p>在调用过滤器链中的下一个实体之后，在响应上直接设置header。</p>
</li>
</ol>
</li>
</ol>
<h4 id="5-4-4-4-FilterChain"><a href="#5-4-4-4-FilterChain" class="headerlink" title="5.4.4.4 FilterChain"></a>5.4.4.4 FilterChain</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FilterChain</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> IOException, ServletException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ApplicationFilterChain是其实现子类</p>
<p><img src="http://ww1.sinaimg.cn/large/0063bT3ggy1fl65phrspxj30ks0dw3yx.jpg" alt=""></p>
<ul>
<li>doFilter最后会调用servlet的servlet方法</li>
<li>lastServicedRequest和lastServicedResponse是线程本地变量，在一次请求中的线程是不会变的。</li>
<li>FilterChain保存的链是ApplicationFilterConfig对象</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;</span><br><span class="line">    <span class="keyword">final</span> ServletRequest req = request;</span><br><span class="line">    <span class="keyword">final</span> ServletResponse res = response;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      java.security.AccessController.doPrivileged(</span><br><span class="line">        <span class="keyword">new</span> java.security.PrivilegedExceptionAction&lt;Void&gt;() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">            internalDoFilter(req,res);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">catch</span>( PrivilegedActionException pe) &#123;</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    internalDoFilter(request,response);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">internalDoFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Call the next filter if there is one</span></span><br><span class="line">  <span class="keyword">if</span> (pos &lt; n) &#123;</span><br><span class="line">    ApplicationFilterConfig filterConfig = filters[pos++];</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Filter filter = filterConfig.getFilter();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (request.isAsyncSupported() &amp;&amp; <span class="string">"false"</span>.equalsIgnoreCase(</span><br><span class="line">        filterConfig.getFilterDef().getAsyncSupported())) &#123;</span><br><span class="line">        request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR, Boolean.FALSE);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;</span><br><span class="line">        <span class="keyword">final</span> ServletRequest req = request;</span><br><span class="line">        <span class="keyword">final</span> ServletResponse res = response;</span><br><span class="line">        Principal principal =</span><br><span class="line">          ((HttpServletRequest) req).getUserPrincipal();</span><br><span class="line">        Object[] args = <span class="keyword">new</span> Object[]&#123;req, res, <span class="keyword">this</span>&#125;;</span><br><span class="line">        SecurityUtil.doAsPrivilege (<span class="string">"doFilter"</span>, filter, classType, args, principal);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        filter.doFilter(request, response, <span class="keyword">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException | ServletException | RuntimeException e) &#123;</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We fell off the end of the chain -- call the servlet instance</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ApplicationDispatcher.WRAP_SAME_OBJECT) &#123;</span><br><span class="line">      lastServicedRequest.set(request);</span><br><span class="line">      lastServicedResponse.set(response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (request.isAsyncSupported() &amp;&amp; !servletSupportsAsync) &#123;</span><br><span class="line">      request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR,</span><br><span class="line">                           Boolean.FALSE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Use potentially wrapped request from this point</span></span><br><span class="line">    <span class="keyword">if</span> ((request <span class="keyword">instanceof</span> HttpServletRequest) &amp;&amp;</span><br><span class="line">        (response <span class="keyword">instanceof</span> HttpServletResponse) &amp;&amp;</span><br><span class="line">        Globals.IS_SECURITY_ENABLED ) &#123;</span><br><span class="line">      <span class="keyword">final</span> ServletRequest req = request;</span><br><span class="line">      <span class="keyword">final</span> ServletResponse res = response;</span><br><span class="line">      Principal principal =</span><br><span class="line">        ((HttpServletRequest) req).getUserPrincipal();</span><br><span class="line">      Object[] args = <span class="keyword">new</span> Object[]&#123;req, res&#125;;</span><br><span class="line">      SecurityUtil.doAsPrivilege(<span class="string">"service"</span>,</span><br><span class="line">                                 servlet,</span><br><span class="line">                                 classTypeUsedInService,</span><br><span class="line">                                 args,</span><br><span class="line">                                 principal);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      servlet.service(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException | ServletException | RuntimeException e) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ApplicationDispatcher.WRAP_SAME_OBJECT) &#123;</span><br><span class="line">      lastServicedRequest.set(<span class="keyword">null</span>);</span><br><span class="line">      lastServicedResponse.set(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-4-5-5-过滤器链的创建"><a href="#5-4-5-5-过滤器链的创建" class="headerlink" title="5.4.5.5 过滤器链的创建"></a>5.4.5.5 过滤器链的创建</h4><p>利用ApplicationFilterFactory创建</p>
<p>filter配置实例：url-pattern是必选的</p>
<p><img src="http://ww1.sinaimg.cn/large/0063bT3ggy1fl6731h9kcj30m906ft8s.jpg" alt=""></p>
<p>FilterConfig对象保存在context的filterConfigs中，通过匹配DispatcherType和servlet-name和url匹配，在33和49行。FilterMap和xml的属性基本一样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationFilterChain <span class="title">createFilterChain</span><span class="params">(ServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">		Wrapper wrapper, Servlet servlet)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (servlet == <span class="keyword">null</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">// Create and initialize a filter chain object</span></span><br><span class="line">	ApplicationFilterChain filterChain = <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">//略去处理</span></span><br><span class="line">	filterChain = <span class="keyword">new</span> ApplicationFilterChain();</span><br><span class="line"></span><br><span class="line">	filterChain.setServlet(servlet);</span><br><span class="line">	filterChain.setServletSupportsAsync(wrapper.isAsyncSupported());</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Acquire the filter mappings for this Context</span></span><br><span class="line">	StandardContext context = (StandardContext) wrapper.getParent();</span><br><span class="line">	FilterMap filterMaps[] = context.findFilterMaps();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If there are no filter mappings, we are done</span></span><br><span class="line">	<span class="keyword">if</span> ((filterMaps == <span class="keyword">null</span>) || (filterMaps.length == <span class="number">0</span>))</span><br><span class="line">		<span class="keyword">return</span> (filterChain);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Acquire the information we will need to match filter mappings</span></span><br><span class="line">	DispatcherType dispatcher =</span><br><span class="line">			(DispatcherType) request.getAttribute(Globals.DISPATCHER_TYPE_ATTR);</span><br><span class="line"></span><br><span class="line">	String requestPath = <span class="keyword">null</span>;</span><br><span class="line">	Object attribute = request.getAttribute(Globals.DISPATCHER_REQUEST_PATH_ATTR);</span><br><span class="line">	<span class="keyword">if</span> (attribute != <span class="keyword">null</span>)&#123;</span><br><span class="line">		requestPath = attribute.toString();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	String servletName = wrapper.getName();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Add the relevant path-mapped filters to this filter chain</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!matchDispatcher(filterMaps[i] ,dispatcher)) &#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!matchFiltersURL(filterMaps[i], requestPath))</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)</span><br><span class="line">			context.findFilterConfig(filterMaps[i].getFilterName());</span><br><span class="line">		<span class="keyword">if</span> (filterConfig == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="comment">// FIXME - log configuration problem</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		filterChain.addFilter(filterConfig);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Add filters that match on servlet name second</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!matchDispatcher(filterMaps[i] ,dispatcher)) &#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!matchFiltersServlet(filterMaps[i], servletName))</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)</span><br><span class="line">			context.findFilterConfig(filterMaps[i].getFilterName());</span><br><span class="line">		<span class="keyword">if</span> (filterConfig == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="comment">// FIXME - log configuration problem</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		filterChain.addFilter(filterConfig);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Return the completed filter chain</span></span><br><span class="line">	<span class="keyword">return</span> filterChain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><ol>
<li><p>既然SingleThreadModel无法保证线程安全，那如何处理？</p>
<p>编写无状态的代码</p>
</li>
<li><p>servlet和filter关系</p>
<p>filter过滤servlet，但两者都是独立的，创建FilterChain都是动态的，用完销毁，但filter和servlet对象都缓存在FilterConfig和Wrapper中，创建FilterChain的效率是很高的</p>
</li>
</ol>
<h2 id="5-4-Context容器"><a href="#5-4-Context容器" class="headerlink" title="5.4 Context容器"></a>5.4 Context容器</h2><p>Context容器代表一个应用程序的</p>
<h3 id="5-4-1-Context接口"><a href="#5-4-1-Context接口" class="headerlink" title="5.4.1 Context接口"></a>5.4.1 Context接口</h3><p>Context实例代表一个具体的web应用程序，其中包含一个或者多个Wrapper实例。但是Context还支持其他组件，如Sessiong管理器，ClassLoader等</p>
<p>主要定义了一些子组件，监听器，状态变量的增删改查等</p>
<ul>
<li><p>注意这里的监听器是String类型，实际上是class name的</p>
</li>
<li><p>servlet名称映射</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> HashMap&lt;String, ApplicationFilterConfig&gt; filterConfigs =</span><br><span class="line">        <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">//名称-Conf映射，filter缓存在ApplicationFilterConfig中</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFilterDef</span><span class="params">(FilterDef filterDef)</span></span>;<span class="comment">//&lt;String, FilterDef&gt;，Def与xml配置对应</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFilterMap</span><span class="params">(FilterMap filterMap)</span></span>;<span class="comment">//数组实现，一个FilterMap保存了一个filterName和一系列对应的servletName的关系。创建filter链的时候通过filterMap内部的url或servletName匹配，匹配成功再通过filterName和filterConfigs获取ApplicationFilterConfig，ApplicationFilterConfig中持有filter对象</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addServletMappingDecoded</span><span class="params">(String pattern, String name)</span></span>;<span class="comment">//url pattern与servletName的映射</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addServletMappingDecoded</span><span class="params">(String pattern, String name, <span class="keyword">boolean</span> jspWildcard)</span></span>;</span><br></pre></td></tr></table></figure>
<p>​</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Context</span> <span class="keyword">extends</span> <span class="title">Container</span>, <span class="title">ContextBind</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ----------------------------------------------------- Manifest Constants</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 事件常量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ADD_WELCOME_FILE_EVENT = <span class="string">"addWelcomeFile"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REMOVE_WELCOME_FILE_EVENT = <span class="string">"removeWelcomeFile"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String  CLEAR_WELCOME_FILES_EVENT = <span class="string">"clearWelcomeFiles"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CHANGE_SESSION_ID_EVENT = <span class="string">"changeSessionId"</span>;</span><br><span class="line">    <span class="comment">// ------------------------------------------------------------- Properties</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否允许解析Mutipart</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getAllowCasualMultipartParsing</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAllowCasualMultipartParsing</span><span class="params">(<span class="keyword">boolean</span> allowCasualMultipartParsing)</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * app监听器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object[] getApplicationEventListeners();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationEventListeners</span><span class="params">(Object listeners[])</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Lifecycle监听器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object[] getApplicationLifecycleListeners();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationLifecycleListeners</span><span class="params">(Object listeners[])</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取编码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCharset</span><span class="params">(Locale locale)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * URL of the XML descriptor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> URL <span class="title">getConfigFile</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConfigFile</span><span class="params">(URL configFile)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否配置过</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getConfigured</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConfigured</span><span class="params">(<span class="keyword">boolean</span> configured)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否用cookies</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getCookies</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCookies</span><span class="params">(<span class="keyword">boolean</span> cookies)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * cookies name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSessionCookieName</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSessionCookieName</span><span class="params">(String sessionCookieName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getUseHttpOnly</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUseHttpOnly</span><span class="params">(<span class="keyword">boolean</span> useHttpOnly)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cookie域，可用于跨域访问</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSessionCookieDomain</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSessionCookieDomain</span><span class="params">(String sessionCookieDomain)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * path表示cookie所在的目录</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSessionCookiePath</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSessionCookiePath</span><span class="params">(String sessionCookiePath)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getCrossContext</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCrossContext</span><span class="params">(<span class="keyword">boolean</span> crossContext)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发布名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAltDDName</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAltDDName</span><span class="params">(String altDDName)</span> </span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 展示名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDisplayName</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDisplayName</span><span class="params">(String displayName)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否是分布式的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getDistributable</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDistributable</span><span class="params">(<span class="keyword">boolean</span> distributable)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * root目录</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDocBase</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDocBase</span><span class="params">(String docBase)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * URL encoded context path </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getEncodedPath</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登陆配置 ，如loginPage，errorPage等</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LoginConfig <span class="title">getLoginConfig</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoginConfig</span><span class="params">(LoginConfig config)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * context path for this web application.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPath</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPath</span><span class="params">(String path)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* reload</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getReloadable</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReloadable</span><span class="params">(<span class="keyword">boolean</span> reloadable)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * override</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getOverride</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOverride</span><span class="params">(<span class="keyword">boolean</span> override)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * privileged</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getPrivileged</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrivileged</span><span class="params">(<span class="keyword">boolean</span> privileged)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * the Servlet context for which this Context is a facade.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletContext <span class="title">getServletContext</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * the default session timeout (in minutes)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSessionTimeout</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSessionTimeout</span><span class="params">(<span class="keyword">int</span> timeout)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getWrapperClass</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWrapperClass</span><span class="params">(String wrapperClass)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authenticator <span class="title">getAuthenticator</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InstanceManager <span class="title">getInstanceManager</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setInstanceManager</span><span class="params">(InstanceManager instanceManager)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --------------------------------------------------------- Public Methods</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addApplicationListener</span><span class="params">(String listener)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addApplicationParameter</span><span class="params">(ApplicationParameter parameter)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addErrorPage</span><span class="params">(ErrorPage errorPage)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFilterDef</span><span class="params">(FilterDef filterDef)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFilterMap</span><span class="params">(FilterMap filterMap)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFilterMapBefore</span><span class="params">(FilterMap filterMap)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLocaleEncodingMappingParameter</span><span class="params">(String locale, String encoding)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMimeMapping</span><span class="params">(String extension, String mimeType)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addParameter</span><span class="params">(String name, String value)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRoleMapping</span><span class="params">(String role, String link)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addSecurityRole</span><span class="params">(String role)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addServletMapping</span><span class="params">(String pattern, String name)</span></span>;</span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addServletMapping</span><span class="params">(String pattern, String name, <span class="keyword">boolean</span> jspWildcard)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addServletMappingDecoded</span><span class="params">(String pattern, String name)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addServletMappingDecoded</span><span class="params">(String pattern, String name, <span class="keyword">boolean</span> jspWildcard)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addWelcomeFile</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Add the classname of a LifecycleListener</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addWrapperLifecycle</span><span class="params">(String listener)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Add the classname of a ContainerListener</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addWrapperListener</span><span class="params">(String listener)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Wrapper <span class="title">createWrapper</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">public</span> String[] findApplicationListeners();</span><br><span class="line">    <span class="keyword">public</span> ApplicationParameter[] findApplicationParameters();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ErrorPage <span class="title">findErrorPage</span><span class="params">(<span class="keyword">int</span> errorCode)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ErrorPage <span class="title">findErrorPage</span><span class="params">(String exceptionType)</span></span>;</span><br><span class="line">    <span class="keyword">public</span> ErrorPage[] findErrorPages();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterDef <span class="title">findFilterDef</span><span class="params">(String filterName)</span></span>;</span><br><span class="line">    <span class="keyword">public</span> FilterDef[] findFilterDefs();</span><br><span class="line">    <span class="keyword">public</span> FilterMap[] findFilterMaps();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">findParameter</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="keyword">public</span> String[] findParameters();</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the servlet name mapped by the specified pattern (if any);</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">findServletMapping</span><span class="params">(String pattern)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the patterns of all defined servlet mappings for this</span></span><br><span class="line"><span class="comment">     * Context. </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String[] findServletMappings();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the context-relative URI of the error page for the specified</span></span><br><span class="line"><span class="comment">     * HTTP status code, if any; otherwise return &lt;code&gt;null&lt;/code&gt;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">findStatusPage</span><span class="params">(<span class="keyword">int</span> status)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the set of HTTP status codes for which error pages have</span></span><br><span class="line"><span class="comment">     * been specified.  If none are specified, a zero-length array</span></span><br><span class="line"><span class="comment">     * is returned.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] findStatusPages();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the associated ThreadBindingListener.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadBindingListener <span class="title">getThreadBindingListener</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setThreadBindingListener</span><span class="params">(ThreadBindingListener threadBindingListener)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the set of watched resources for this Context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String[] findWatchedResources();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">findWelcomeFile</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="keyword">public</span> String[] findWelcomeFiles();</span><br><span class="line">    <span class="keyword">public</span> String[] findWrapperLifecycles();</span><br><span class="line">    <span class="keyword">public</span> String[] findWrapperListeners();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notify all &#123;<span class="doctag">@link</span> javax.servlet.ServletRequestListener&#125;s that a request</span></span><br><span class="line"><span class="comment">     * has started.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">fireRequestInitEvent</span><span class="params">(ServletRequest request)</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notify all &#123;<span class="doctag">@link</span> javax.servlet.ServletRequestListener&#125;s that a request</span></span><br><span class="line"><span class="comment">     * has ended.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">fireRequestDestroyEvent</span><span class="params">(ServletRequest request)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reload</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeApplicationListener</span><span class="params">(String listener)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeApplicationParameter</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeErrorPage</span><span class="params">(ErrorPage errorPage)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeFilterDef</span><span class="params">(FilterDef filterDef)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeFilterMap</span><span class="params">(FilterMap filterMap)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeMimeMapping</span><span class="params">(String extension)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeParameter</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeServletMapping</span><span class="params">(String pattern)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeWatchedResource</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeWelcomeFile</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeWrapperLifecycle</span><span class="params">(String listener)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeWrapperListener</span><span class="params">(String listener)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the real path for a given virtual path</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRealPath</span><span class="params">(String path)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Is this Context paused whilst it is reloaded?</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getPaused</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the base name to use for WARs, directories or context.xml files</span></span><br><span class="line"><span class="comment">     * for this context.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBaseName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWebappVersion</span><span class="params">(String webappVersion)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getWebappVersion</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFireRequestListenersOnForwards</span><span class="params">(<span class="keyword">boolean</span> enable)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getFireRequestListenersOnForwards</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSendRedirectBody</span><span class="params">(<span class="keyword">boolean</span> enable)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getSendRedirectBody</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Loader <span class="title">getLoader</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoader</span><span class="params">(Loader loader)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WebResourceRoot <span class="title">getResources</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResources</span><span class="params">(WebResourceRoot resources)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Manager <span class="title">getManager</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setManager</span><span class="params">(Manager manager)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCookieProcessor</span><span class="params">(CookieProcessor cookieProcessor)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CookieProcessor <span class="title">getCookieProcessor</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRequestCharacterEncoding</span><span class="params">(String encoding)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRequestCharacterEncoding</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResponseCharacterEncoding</span><span class="params">(String encoding)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getResponseCharacterEncoding</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-4-2-StandardContext"><a href="#5-4-2-StandardContext" class="headerlink" title="5.4.2 StandardContext"></a>5.4.2 StandardContext</h3><p>StandardContext是org.apache.catalina.Context的标准实现，继承自ContainerBase基容器，具备容器的功能，包含Wrapper容器，它的角色是管理在其内部的Wrapper，从Host那里接收请求信息，加载实例化Servlet，然后选择一个合适的Wrapper处理，同一个Context内部中Servlet数据共享，不同Context之间数据隔离。在Context层面上，Filter的作用就出来了，Filter是用来过滤Servlet的组件，Context负责在每个Servlet上面调用Filter过滤，Context与开发Servlet息息相关，跟前面的几个组件相比，Context能够提供更多的信息给Servlet。一个webapp有一个Context，Context负责管理在其内部的组件：Servlet，Cookie，Session等等。</p>
<h4 id="5-4-2-1-主要成员"><a href="#5-4-2-1-主要成员" class="headerlink" title="5.4.2.1 主要成员"></a>5.4.2.1 主要成员</h4><h4 id="5-4-2-2-构造函数"><a href="#5-4-2-2-构造函数" class="headerlink" title="5.4.2.2 构造函数"></a>5.4.2.2 构造函数</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">StandardContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">super</span>();</span><br><span class="line">  pipeline.setBasic(<span class="keyword">new</span> StandardContextValve());</span><br><span class="line">  broadcaster = <span class="keyword">new</span> NotificationBroadcasterSupport();</span><br><span class="line">  <span class="comment">// Set defaults</span></span><br><span class="line">  <span class="keyword">if</span> (!Globals.STRICT_SERVLET_COMPLIANCE) &#123;</span><br><span class="line">    <span class="comment">// Strict servlet compliance requires all extension mapped servlets</span></span><br><span class="line">    <span class="comment">// to be checked against welcome files</span></span><br><span class="line">    resourceOnlyServlets.add(<span class="string">"jsp"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-4-2-3-startInternal"><a href="#5-4-2-3-startInternal" class="headerlink" title="5.4.2.3 startInternal"></a>5.4.2.3 startInternal</h4><p>startInternal方法主要完成以下工作：</p>
<ol>
<li>广播启动事件 broadcaster.sendNotification(notification);</li>
<li>设置configured为false</li>
<li>配置资源  setResources(new StandardRoot(this));</li>
<li>配置classLoader  setLoader(new WebappLoader(getParentClassLoader()));</li>
<li>设置cookieProcessor  cookieProcessor = new Rfc6265CookieProcessor();</li>
<li>初始化字符串映射集合 getCharsetMapper();</li>
<li>启动相关组件<ol>
<li>启动classLoader ((Lifecycle) loader).start()</li>
<li>启动Realm ((Lifecycle) realm).start();</li>
<li>启动子容器 child.start();</li>
<li>启动管道 ((Lifecycle) pipeline).start();</li>
<li>启动SessionManager ContextManager new StandardManager(); ((Lifecycle) manager).start();</li>
</ol>
</li>
<li>触发start过failed事件</li>
</ol>
<h4 id="5-4-2-4-stopInternal"><a href="#5-4-2-4-stopInternal" class="headerlink" title="5.4.2.4 stopInternal"></a>5.4.2.4 stopInternal</h4><p>stopInternal与startInternal相反</p>
<h4 id="5-4-2-5-destroyInternal"><a href="#5-4-2-5-destroyInternal" class="headerlink" title="5.4.2.5 destroyInternal"></a>5.4.2.5 destroyInternal</h4><p>销毁子组件</p>
<h4 id="5-4-2-6-backgroundProcess"><a href="#5-4-2-6-backgroundProcess" class="headerlink" title="5.4.2.6 backgroundProcess"></a>5.4.2.6 backgroundProcess</h4><p>调用子组件的backgroundProcess</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">backgroundProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!getState().isAvailable())</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	Loader loader = getLoader();</span><br><span class="line">	<span class="keyword">if</span> (loader != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			loader.backgroundProcess();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			log.warn(sm.getString(</span><br><span class="line">					<span class="string">"standardContext.backgroundProcess.loader"</span>, loader), e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	Manager manager = getManager();</span><br><span class="line">	<span class="keyword">if</span> (manager != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			manager.backgroundProcess();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			log.warn(sm.getString(</span><br><span class="line">					<span class="string">"standardContext.backgroundProcess.manager"</span>, manager),</span><br><span class="line">					e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	WebResourceRoot resources = getResources();</span><br><span class="line">	<span class="keyword">if</span> (resources != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			resources.backgroundProcess();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			log.warn(sm.getString(</span><br><span class="line">					<span class="string">"standardContext.backgroundProcess.resources"</span>,</span><br><span class="line">					resources), e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	InstanceManager instanceManager = getInstanceManager();</span><br><span class="line">	<span class="keyword">if</span> (instanceManager <span class="keyword">instanceof</span> DefaultInstanceManager) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			((DefaultInstanceManager)instanceManager).backgroundProcess();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			log.warn(sm.getString(</span><br><span class="line">					<span class="string">"standardContext.backgroundProcess.instanceManager"</span>,</span><br><span class="line">					resources), e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">super</span>.backgroundProcess();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-4-2-7-reload"><a href="#5-4-2-7-reload" class="headerlink" title="5.4.2.7 reload"></a>5.4.2.7 reload</h4><p>synchronized同步的，start–&gt;stop</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">reload</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Validate our current component state</span></span><br><span class="line">  <span class="keyword">if</span> (!getState().isAvailable())</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException</span><br><span class="line">    (sm.getString(<span class="string">"standardContext.notStarted"</span>, getName()));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(log.isInfoEnabled())</span><br><span class="line">    log.info(sm.getString(<span class="string">"standardContext.reloadingStarted"</span>,</span><br><span class="line">                          getName()));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Stop accepting requests temporarily.</span></span><br><span class="line">  setPaused(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    stop();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">    log.error(</span><br><span class="line">      sm.getString(<span class="string">"standardContext.stoppingContext"</span>, getName()), e);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    start();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">    log.error(</span><br><span class="line">      sm.getString(<span class="string">"standardContext.startingContext"</span>, getName()), e);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setPaused(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(log.isInfoEnabled())</span><br><span class="line">    log.info(sm.getString(<span class="string">"standardContext.reloadingCompleted"</span>,</span><br><span class="line">                          getName()));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-4-3-WebResourceRoot"><a href="#5-4-3-WebResourceRoot" class="headerlink" title="5.4.3 WebResourceRoot"></a>5.4.3 WebResourceRoot</h3><p>表示Web应用程序的完整资源集合。 Web应用程序的资源由多个资源集组成，当查找资源时，ResourceSets按以下顺序处理：</p>
<ol>
<li>Pre - 由Web应用程序的context.xml中的<preresource>元素定义的资源。 资源将按照指定的顺序进行搜索。</preresource></li>
<li>Main - Web应用程序的主要资源 - 即WAR或包含展开的WAR的目录</li>
<li>JAR - 由Servlet规范定义的资源JAR。 JAR将按照它们添加到ResourceRoot的顺序进行搜索。</li>
<li>Post - 由Web应用程序的context.xml中的<postresource>元素定义的资源。 资源将按照指定的顺序进行搜索。</postresource></li>
</ol>
<p>应该注意以下约定：</p>
<ul>
<li>写操作（包括删除）只会应用于main ResourceSet。 如果其他资源集中某个资源的存在使主ResourceSet上的操作成为NO-OP，则写入操作将失败。</li>
<li>ResourceSet中的文件将隐藏在搜索顺序中靠后的ResourceSet中具有相同名称的目录（以及该目录的所有内容）。</li>
<li>只有主ResourceSet可以定义一个META-INF / context.xml文件，因为该文件定义了Pre和Post资源。</li>
<li>根据Servlet规范，资源JAR中的任何META-INF或WEB-INF目录都将被忽略。</li>
<li>Pre -和Post- 可以定义WEB-INF / lib和WEB-INF /classes，以便为Web应用程序提供额外的库和或类。</li>
</ul>
<p>WebResourceRoot实现了Lifecycle接口，作为管理资源的组件</p>
<p><img src="http://ww1.sinaimg.cn/large/0063bT3ggy1fl8igxjsxhj30fn0q5abb.jpg" alt=""></p>
<h4 id="5-4-3-1-WebResource"><a href="#5-4-3-1-WebResource" class="headerlink" title="5.4.3.1 WebResource"></a>5.4.3.1 WebResource</h4><p>代表web资源，目录或文件，参考File类</p>
<p>内部实现封装了File，略</p>
<h4 id="5-4-3-2-StandardRoot"><a href="#5-4-3-2-StandardRoot" class="headerlink" title="5.4.3.2 StandardRoot"></a>5.4.3.2 StandardRoot</h4><p>WebResourceRoot实现类</p>
<p>成员变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Context context;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;WebResourceSet&gt; preResources = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> WebResourceSet main;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;WebResourceSet&gt; mainResources = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;WebResourceSet&gt; classResources = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;WebResourceSet&gt; jarResources = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;WebResourceSet&gt; postResources = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Cache cache= <span class="keyword">new</span> Cache(<span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<p>Cache负责缓存，用CurrencyHashMap缓存， 内部通过backgroundProcess() 来刷新缓存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StandardRoot</span></span></span><br><span class="line"><span class="class">	@<span class="title">Override</span></span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">void</span> <span class="title">backgroundProcess</span>() </span>&#123;</span><br><span class="line">        cache.backgroundProcess();</span><br><span class="line">        gc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">backgroundProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    TreeSet&lt;CachedResource&gt; orderedResources =</span><br><span class="line">      <span class="keyword">new</span> TreeSet&lt;&gt;(<span class="keyword">new</span> EvictionOrder());</span><br><span class="line">    orderedResources.addAll(resourceCache.values());</span><br><span class="line"></span><br><span class="line">    Iterator&lt;CachedResource&gt; iter = orderedResources.iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> targetSize =</span><br><span class="line">      maxSize * (<span class="number">100</span> - TARGET_FREE_PERCENT_BACKGROUND) / <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">long</span> newSize = evict(targetSize, iter);</span><br><span class="line"></span><br><span class="line">  &#125; </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">evict</span><span class="params">(<span class="keyword">long</span> targetSize, Iterator&lt;CachedResource&gt; iter)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">long</span> newSize = size.get();</span><br><span class="line">    <span class="keyword">while</span> (newSize &gt; targetSize &amp;&amp; iter.hasNext()) &#123;</span><br><span class="line">      CachedResource resource = iter.next();</span><br><span class="line">      <span class="comment">// Don't expire anything that has been checked within the TTL</span></span><br><span class="line">      <span class="keyword">if</span> (resource.getNextCheck() &gt; now) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Remove the entry from the cache</span></span><br><span class="line">      removeCacheEntry(resource.getWebappPath());</span><br><span class="line">      newSize = size.get();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newSize;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>gc()方法是调用所有的WebResourceSet的gc()，有的WebResourceSet实现类会在内部做缓存</p>
<h3 id="5-4-4-StandardContextValve"><a href="#5-4-4-StandardContextValve" class="headerlink" title="5.4.4 StandardContextValve"></a>5.4.4 StandardContextValve</h3><p>StandardContext容器实现的基本Valve。</p>
<ul>
<li>调用是直接调用子类的pipeLine的，也就是说容器就只是容器，不负责任何调用，由pipeLine完成</li>
<li><code>Wrapper wrapper = request.getWrapper();</code>选择Wrapper由request完成</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">StandardContextValve</span> <span class="keyword">extends</span> <span class="title">ValveBase</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> StringManager sm = </span><br><span class="line">    				StringManager.getManager(StandardContextValve.class);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">StandardContextValve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(<span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据指定的请求URI，选择适当的Wrapper处理此请求。 如果找不到匹配的Wrapper，</span></span><br><span class="line"><span class="comment">     * 则返回适当的HTTP错误。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 禁止直接访问 WEB-INF or META-INF</span></span><br><span class="line">    MessageBytes requestPathMB = request.getRequestPathMB();</span><br><span class="line">    <span class="keyword">if</span> ((requestPathMB.startsWithIgnoreCase(<span class="string">"/META-INF/"</span>, <span class="number">0</span>))</span><br><span class="line">        || (requestPathMB.equalsIgnoreCase(<span class="string">"/META-INF"</span>))</span><br><span class="line">        || (requestPathMB.startsWithIgnoreCase(<span class="string">"/WEB-INF/"</span>, <span class="number">0</span>))</span><br><span class="line">        || (requestPathMB.equalsIgnoreCase(<span class="string">"/WEB-INF"</span>))) &#123;</span><br><span class="line">      response.sendError(HttpServletResponse.SC_NOT_FOUND);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 选择Wrapper</span></span><br><span class="line">    Wrapper wrapper = request.getWrapper();</span><br><span class="line">    <span class="keyword">if</span> (wrapper == <span class="keyword">null</span> || wrapper.isUnavailable()) &#123;</span><br><span class="line">      response.sendError(HttpServletResponse.SC_NOT_FOUND);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Acknowledge the request</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      response.sendAcknowledgement();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">      container.getLogger().error(sm.getString(</span><br><span class="line">        <span class="string">"standardContextValve.acknowledgeException"</span>), ioe);</span><br><span class="line">      request.setAttribute(RequestDispatcher.ERROR_EXCEPTION, ioe);</span><br><span class="line">      response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (request.isAsyncSupported()) &#123;</span><br><span class="line">      request.setAsyncSupported(wrapper.getPipeline().isAsyncSupported());</span><br><span class="line">    &#125;</span><br><span class="line">    wrapper.getPipeline().getFirst().invoke(request, response);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-5-Host"><a href="#5-5-Host" class="headerlink" title="5.5 Host"></a>5.5 Host</h2><p>Host是一个容器，代表Catalina servlet引擎中的虚拟主机。用于：</p>
<ul>
<li>您希望使用拦截器来查看由此特定虚拟主机处理的每个请求。</li>
<li>希望使用独立的HTTP连接器运行Catalina，但仍希望支持多个虚拟主机。</li>
</ul>
<p>一般来说，在部署Catalina连接到Web服务器（如Apache）时，不会使用Host，因为连接器将利用Web服务器的组件来确定应该使用哪个Context（或者甚至是Wrapper）来处理这个请求。</p>
<p>连接到Host的父容器通常是一个Engine，但可能是其他一些实现，或者如果没有必要，可以省略。连接到主机的子容器通常是Context的实现。</p>
<p><img src="http://ww1.sinaimg.cn/large/0063bT3ggy1fl8om2diiwj30ib0fadgq.jpg" alt=""></p>
<h3 id="5-5-1-StandardHost"><a href="#5-5-1-StandardHost" class="headerlink" title="5.5.1 StandardHost"></a>5.5.1 StandardHost</h3><p>Host接口的标准实现</p>
<p>startInternal只是用来添加个errorValve，默认是org.apache.catalina.valves.ErrorReportValve</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set error report valve</span></span><br><span class="line">  String errorValve = getErrorReportValveClass();</span><br><span class="line">  <span class="keyword">if</span> ((errorValve != <span class="keyword">null</span>) &amp;&amp; (!errorValve.equals(<span class="string">""</span>))) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">boolean</span> found = <span class="keyword">false</span>;</span><br><span class="line">      Valve[] valves = getPipeline().getValves();</span><br><span class="line">      <span class="keyword">for</span> (Valve valve : valves) &#123;</span><br><span class="line">        <span class="keyword">if</span> (errorValve.equals(valve.getClass().getName())) &#123;</span><br><span class="line">          found = <span class="keyword">true</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span>(!found) &#123;</span><br><span class="line">        Valve valve =</span><br><span class="line">          (Valve) Class.forName(errorValve).getConstructor().newInstance();</span><br><span class="line">        getPipeline().addValve(valve);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      ExceptionUtils.handleThrowable(t);</span><br><span class="line">      log.error(sm.getString(</span><br><span class="line">        <span class="string">"standardHost.invalidErrorReportValveClass"</span>,</span><br><span class="line">        errorValve), t);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">super</span>.startInternal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-5-2-StandardHostValve"><a href="#5-5-2-StandardHostValve" class="headerlink" title="5.5.2 StandardHostValve"></a>5.5.2 StandardHostValve</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 选择合适子Context处理请求</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span></span><br><span class="line"><span class="function">	<span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Select the Context to be used for this Request</span></span><br><span class="line">	Context context = request.getContext();</span><br><span class="line">	<span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line">		response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR,</span><br><span class="line">			 sm.getString(<span class="string">"standardHost.noContext"</span>));</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (request.isAsyncSupported()) &#123;</span><br><span class="line">		request.setAsyncSupported(context.getPipeline().isAsyncSupported());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">boolean</span> asyncAtStart = request.isAsync();</span><br><span class="line">	<span class="keyword">boolean</span> asyncDispatching = request.isAsyncDispatching();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		context.bind(Globals.IS_SECURITY_ENABLED, MY_CLASSLOADER);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!asyncAtStart &amp;&amp; !context.fireRequestInitEvent(request.getRequest())) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (!asyncAtStart || asyncDispatching) &#123;</span><br><span class="line">				context.getPipeline().getFirst().invoke(request, response);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (!response.isErrorReportRequired()) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(sm.getString(<span class="string">"standardHost.asyncStateError"</span>));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">			ExceptionUtils.handleThrowable(t);</span><br><span class="line">			container.getLogger().error(<span class="string">"Exception Processing "</span> + request.getRequestURI(), t);</span><br><span class="line">			<span class="comment">// If a new error occurred while trying to report a previous</span></span><br><span class="line">			<span class="comment">// error allow the original error to be reported.</span></span><br><span class="line">			<span class="keyword">if</span> (!response.isErrorReportRequired()) &#123;</span><br><span class="line">				request.setAttribute(RequestDispatcher.ERROR_EXCEPTION, t);</span><br><span class="line">				throwable(request, response, t);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Now that the request/response pair is back under container</span></span><br><span class="line">		<span class="comment">// control lift the suspension so that the error handling can</span></span><br><span class="line">		<span class="comment">// complete and/or the container can flush any remaining data</span></span><br><span class="line">		response.setSuspended(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">		Throwable t = (Throwable) request.getAttribute(RequestDispatcher.ERROR_EXCEPTION);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Protect against NPEs if the context was destroyed during a</span></span><br><span class="line">		<span class="comment">// long running request.</span></span><br><span class="line">		<span class="keyword">if</span> (!context.getState().isAvailable()) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Look for (and render if found) an application level error page</span></span><br><span class="line">		<span class="keyword">if</span> (response.isErrorReportRequired()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</span><br><span class="line">				throwable(request, response, t);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				status(request, response);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!request.isAsync() &amp;&amp; !asyncAtStart) &#123;</span><br><span class="line">			context.fireRequestDestroyEvent(request.getRequest());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="comment">// Access a session (if present) to update last accessed time, based</span></span><br><span class="line">		<span class="comment">// on a strict interpretation of the specification</span></span><br><span class="line">		<span class="keyword">if</span> (ACCESS_SESSION) &#123;</span><br><span class="line">			request.getSession(<span class="keyword">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		context.unbind(Globals.IS_SECURITY_ENABLED, MY_CLASSLOADER);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-6-Engine"><a href="#5-6-Engine" class="headerlink" title="5.6 Engine"></a>5.6 Engine</h2><p>引擎是一个代表整个Catalina servlet引擎的容器。</p>
<ul>
<li>您希望使用拦截器来查看整个引擎处理的每个请求。</li>
<li>希望使用独立的HTTP连接器运行Catalina，但仍希望支持多个虚拟主机。</li>
</ul>
<p>一般来说，当部署连接到Web服务器（如Apache）的Catalina时，不会使用引擎，因为连接器将利用Web服务器来确定应该使用哪个上下文（或者甚至是哪个包装器）来处理请求。</p>
<p>连接到Engine的子容器通常是Host的实现（表示一个虚拟主机）或Context（表示一个单独的Servlet上下文），这取决于Engine的实现。</p>
<p>如果使用，Engine始终是Catalina层次结构中的顶级Container。因此，实现的setParent（）方法应抛出IllegalArgumentException。</p>
<p><img src="http://ww1.sinaimg.cn/large/0063bT3ggy1fl8pkdoezjj30ed04h0sq.jpg" alt=""></p>
<p>Service包含了连接器组件，暂时不考虑</p>
<h3 id="5-6-1-StandardEngine"><a href="#5-6-1-StandardEngine" class="headerlink" title="5.6.1 StandardEngine"></a>5.6.1 StandardEngine</h3><p>Engine的标准实现</p>
<h3 id="5-6-2-StandardEngineValve"><a href="#5-6-2-StandardEngineValve" class="headerlink" title="5.6.2 StandardEngineValve"></a>5.6.2 StandardEngineValve</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Select the Host to be used for this Request</span></span><br><span class="line">  Host host = request.getHost();</span><br><span class="line">  <span class="keyword">if</span> (host == <span class="keyword">null</span>) &#123;</span><br><span class="line">    response.sendError</span><br><span class="line">      (HttpServletResponse.SC_BAD_REQUEST,</span><br><span class="line">       sm.getString(<span class="string">"standardEngine.noHost"</span>,</span><br><span class="line">                    request.getServerName()));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (request.isAsyncSupported()) &#123;</span><br><span class="line">    request.setAsyncSupported(host.getPipeline().isAsyncSupported());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Ask this Host to process this request</span></span><br><span class="line">  host.getPipeline().getFirst().invoke(request, response);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/tomcat/" rel="tag"># tomcat</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/03/16/python基础/python IO&并发&正则/" rel="next" title="python IO&并发&正则">
                <i class="fa fa-chevron-left"></i> python IO&并发&正则
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/03/16/python基础/python基础/" rel="prev" title="python基础">
                python基础 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="http://ww1.sinaimg.cn/large/0063bT3ggy1fpdlwgeh51j305t08q765.jpg"
                alt="王焕" />
            
              <p class="site-author-name" itemprop="name">王焕</p>
              <p class="site-description motion-element" itemprop="description">小码农一个, 欢迎交流</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">109</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">37</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">41</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/huanwang-su" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:1360527082@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#5-servlet容器"><span class="nav-number">1.</span> <span class="nav-text">5 servlet容器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-Container"><span class="nav-number">1.1.</span> <span class="nav-text">5.1 Container</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-1-Lifecycle接口"><span class="nav-number">1.1.1.</span> <span class="nav-text">5.1.1 Lifecycle接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-2-ContainerBase"><span class="nav-number">1.1.2.</span> <span class="nav-text">5.1.2 ContainerBase</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-2-1-Container接口"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">5.1.2.1 Container接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-2-2-JmxEnable接口"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">5.1.2.2 JmxEnable接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-2-3-ContainerBase-实现"><span class="nav-number">1.1.2.3.</span> <span class="nav-text">5.1.2.3 ContainerBase 实现</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-管道任务"><span class="nav-number">1.2.</span> <span class="nav-text">5.2 管道任务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-1-ValveContext-实现阀的遍历"><span class="nav-number">1.2.1.</span> <span class="nav-text">5.2.1 ValveContext 实现阀的遍历</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-2-Contained接口"><span class="nav-number">1.2.2.</span> <span class="nav-text">5.2.2 Contained接口</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-Wrapper容器"><span class="nav-number">1.3.</span> <span class="nav-text">5.3 Wrapper容器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-1-Wrapper接口"><span class="nav-number">1.3.1.</span> <span class="nav-text">5.3.1 Wrapper接口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-1-1-获取servlet："><span class="nav-number">1.3.1.1.</span> <span class="nav-text">5.3.1.1 获取servlet：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-2-StandardWrapper"><span class="nav-number">1.3.2.</span> <span class="nav-text">5.3.2 StandardWrapper</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-2-1-方法调用序列"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">5.3.2.1 方法调用序列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-2-2-load"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">5.3.2.2 load</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-2-2-allocate"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">5.3.2.2 allocate</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-2-2-ServletConfig与初始化"><span class="nav-number">1.3.2.4.</span> <span class="nav-text">5.3.2.2 ServletConfig与初始化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-3-StandardWrapperFacade"><span class="nav-number">1.3.3.</span> <span class="nav-text">5.4.3 StandardWrapperFacade</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-4-StandardWrapperValve"><span class="nav-number">1.3.4.</span> <span class="nav-text">5.4.4 StandardWrapperValve</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-4-过滤器"><span class="nav-number">1.3.5.</span> <span class="nav-text">5.4.4 过滤器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-4-1-FilterDef"><span class="nav-number">1.3.5.1.</span> <span class="nav-text">5.4.4.1 FilterDef</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-4-2-FilterConfig"><span class="nav-number">1.3.5.2.</span> <span class="nav-text">5.4.4.2 FilterConfig</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-4-3-Filter"><span class="nav-number">1.3.5.3.</span> <span class="nav-text">5.4.4.3 Filter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-4-4-FilterChain"><span class="nav-number">1.3.5.4.</span> <span class="nav-text">5.4.4.4 FilterChain</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-5-5-过滤器链的创建"><span class="nav-number">1.3.5.5.</span> <span class="nav-text">5.4.5.5 过滤器链的创建</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#思考"><span class="nav-number">1.3.6.</span> <span class="nav-text">思考</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-4-Context容器"><span class="nav-number">1.4.</span> <span class="nav-text">5.4 Context容器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-1-Context接口"><span class="nav-number">1.4.1.</span> <span class="nav-text">5.4.1 Context接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-2-StandardContext"><span class="nav-number">1.4.2.</span> <span class="nav-text">5.4.2 StandardContext</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-2-1-主要成员"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">5.4.2.1 主要成员</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-2-2-构造函数"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">5.4.2.2 构造函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-2-3-startInternal"><span class="nav-number">1.4.2.3.</span> <span class="nav-text">5.4.2.3 startInternal</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-2-4-stopInternal"><span class="nav-number">1.4.2.4.</span> <span class="nav-text">5.4.2.4 stopInternal</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-2-5-destroyInternal"><span class="nav-number">1.4.2.5.</span> <span class="nav-text">5.4.2.5 destroyInternal</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-2-6-backgroundProcess"><span class="nav-number">1.4.2.6.</span> <span class="nav-text">5.4.2.6 backgroundProcess</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-2-7-reload"><span class="nav-number">1.4.2.7.</span> <span class="nav-text">5.4.2.7 reload</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-3-WebResourceRoot"><span class="nav-number">1.4.3.</span> <span class="nav-text">5.4.3 WebResourceRoot</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-3-1-WebResource"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">5.4.3.1 WebResource</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-3-2-StandardRoot"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">5.4.3.2 StandardRoot</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-4-StandardContextValve"><span class="nav-number">1.4.4.</span> <span class="nav-text">5.4.4 StandardContextValve</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-5-Host"><span class="nav-number">1.5.</span> <span class="nav-text">5.5 Host</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-5-1-StandardHost"><span class="nav-number">1.5.1.</span> <span class="nav-text">5.5.1 StandardHost</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-5-2-StandardHostValve"><span class="nav-number">1.5.2.</span> <span class="nav-text">5.5.2 StandardHostValve</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-6-Engine"><span class="nav-number">1.6.</span> <span class="nav-text">5.6 Engine</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-6-1-StandardEngine"><span class="nav-number">1.6.1.</span> <span class="nav-text">5.6.1 StandardEngine</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-6-2-StandardEngineValve"><span class="nav-number">1.6.2.</span> <span class="nav-text">5.6.2 StandardEngineValve</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">王焕</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  







<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    

    
      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitmint({
            id: '1521160105000',
            owner: 'huanwang-su',
            repo: 'huanwang-su.github.io',
            
            lang: "" || navigator.language || navigator.systemLanguage || navigator.userLanguage,
            
            oauth: {
            
            
                client_secret: '34d77e9ce832508aaae056ce90e868f33b776713',
            
                client_id: '2b519dfb3eabb513db47'
            }});
        gitment.render('gitment-container');
      }

      
      renderGitment();
      
      </script>
    







  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
